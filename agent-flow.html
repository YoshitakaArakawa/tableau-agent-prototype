<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Agent Runtime - Orchestration Blueprint</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{
    --bg:#0b1020; --fg:#e7ecff; --muted:#a7b0d6;
    --card:#111735; --card2:#0f1530; --acc:#8ad0ff; --acc2:#c9f27a;
    --border:#24305f; --chip:#1a2247;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#0d1430 60%);color:var(--fg);font:14px/1.6 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--acc)}
  .wrap{max-width:1200px;margin:0 auto;padding:28px}
  header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
  .badge{background:var(--chip);border:1px solid var(--border);padding:4px 10px;border-radius:24px;color:var(--muted)}
  h1{font-size:26px;margin:0 0 6px;letter-spacing:.2px}
  .lead{color:var(--muted);margin:0 0 12px}
  .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
  h2{font-size:16px;margin:0 0 8px}
  .kvs{display:grid;grid-template-columns:auto 1fr;gap:6px 12px;margin:12px 0}
  .kvs div:nth-child(odd){color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .chip{background:var(--chip);border:1px solid var(--border);padding:4px 8px;border-radius:999px;color:#d6defc}
  .mermaid{background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:10px}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .footer{opacity:.8;color:var(--muted);margin-top:24px}
  details{border:1px dashed var(--border);padding:10px;border-radius:10px}
  summary{cursor:pointer;color:#d8e3ff}
  .ok{color:#7bf0a3}.warn{color:#ffd479}.err{color:#ff9b9b}
  .zoom-controls{display:flex;gap:8px;align-items:center;margin:6px 0;padding:8px;background:var(--card2);border:1px solid var(--border);border-radius:8px;}
  .zoom-controls button{background:var(--chip);border:1px solid var(--border);border-radius:6px;color:var(--fg);padding:4px 12px;cursor:pointer;transition:background-color 0.2s;}
  .zoom-controls button:hover{background:var(--border);}
  .zoomable{transform-origin:top left;transition:transform 0.2s ease;overflow:hidden;width:100%;height:400px;border:1px solid var(--border);border-radius:8px;background:var(--card2);}
  .zoomable.timeline-full{height:calc(100vh - 300px);min-height:500px;}
  .zoomable pre{margin:0;height:100%;overflow:auto;}
  .zoomable svg{display:block;max-width:none;}
  @media (max-width:960px){ .grid,.cols{grid-template-columns:1fr} }
</style>
<script type="module">
  import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
  mermaid.initialize({ startOnLoad: true, theme: 'dark', securityLevel: 'loose' });
</script>
<script>
  const setupZoom = () => {
    document.querySelectorAll('.zoom-controls').forEach((controls) => {
      const zoomable = controls.nextElementSibling;
      if (!zoomable || !zoomable.classList.contains('zoomable')) return;
      let scale = 1;
      const step = 0.25;
      const min = 0.4;
      const max = 3;
      const display = controls.querySelector('.scale-display');
      let isPanning = false;
      let startX, startY, scrollLeft, scrollTop;
      const apply = () => {
        const container = zoomable.querySelector('pre') || zoomable;
        container.style.transform = `scale(${scale})`;
        container.style.transformOrigin = 'top left';
        if (display) display.textContent = `${Math.round(scale * 100)}%`;
        if (scale > 1) {
          const maxScrollLeft = container.scrollWidth - zoomable.clientWidth;
          const maxScrollTop = container.scrollHeight - zoomable.clientHeight;
          zoomable.scrollLeft = Math.max(0, maxScrollLeft * 0.3);
          zoomable.scrollTop = Math.max(0, maxScrollTop * 0.3);
        }
      };
      zoomable.addEventListener('mousedown', (e) => {
        if (scale <= 1) return;
        isPanning = true;
        zoomable.style.cursor = 'grabbing';
        startX = e.pageX - zoomable.offsetLeft;
        startY = e.pageY - zoomable.offsetTop;
        scrollLeft = zoomable.scrollLeft;
        scrollTop = zoomable.scrollTop;
      });
      zoomable.addEventListener('mouseleave', () => {
        isPanning = false;
        zoomable.style.cursor = scale > 1 ? 'grab' : 'default';
      });
      zoomable.addEventListener('mouseup', () => {
        isPanning = false;
        zoomable.style.cursor = scale > 1 ? 'grab' : 'default';
      });
      zoomable.addEventListener('mousemove', (e) => {
        if (!isPanning || scale <= 1) return;
        e.preventDefault();
        const x = e.pageX - zoomable.offsetLeft;
        const y = e.pageY - zoomable.offsetTop;
        const walkX = (x - startX) * 1;
        const walkY = (y - startY) * 1;
        zoomable.scrollLeft = scrollLeft - walkX;
        zoomable.scrollTop = scrollTop - walkY;
      });
      controls.querySelectorAll('button').forEach((btn) => {
        btn.addEventListener('click', () => {
          const action = btn.getAttribute('data-action');
          if (action === 'in') scale = Math.min(max, scale + step);
          if (action === 'out') scale = Math.max(min, scale - step);
          if (action === 'reset') scale = 1;
          if (action === 'fit') {
            const container = zoomable.querySelector('pre');
            if (container) {
              const widthRatio = zoomable.clientWidth / container.scrollWidth;
              const heightRatio = zoomable.clientHeight / container.scrollHeight;
              scale = Math.max(min, Math.min(max, Math.min(widthRatio, heightRatio)));
            } else {
              scale = 1;
            }
          }
          zoomable.style.cursor = scale > 1 ? 'grab' : 'default';
          apply();
        });
      });
      apply();
    });
  };
  window.addEventListener('DOMContentLoaded', setupZoom);
</script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Tableau Agent - Runtime Flow</h1>
        <p class="lead">Current orchestration after merging the analysis planner into triage and enabling VizQL retries driven by Tableau MCP feedback.</p>
      </div>
    </header>

    <section class="card">
      <h2>Turn Sequence</h2>
      <p>The sequence reflects one question/answer turn. Builder retries loop until a valid payload executes or the retry budget (3 attempts) is exhausted.</p>
      <div class="zoom-controls">
        <button data-action="out" type="button">-</button>
        <span>Zoom</span>
        <button data-action="in" type="button">+</button>
        <button data-action="reset" type="button">Reset</button>
        <button data-action="fit" type="button">Fit</button>
        <span class="scale-display">100%</span>
      </div>
      <div class="zoomable">
        <pre class="mermaid">
sequenceDiagram
    participant Server as HTTP Server
    participant Triage as triage agent
    participant Selector as field-selector
    participant Builder as vizql-builder
    participant MCP as Tableau MCP
    participant Summary as summarizer
    participant Store as sessionStore

    Server ->> Triage: triagePhase(message, metadata)
    Triage -->> Server: analysisPlan + requiredFields + filterHints
    Server ->> Selector: runFieldSelector(MAX_N=3, hints)
    Selector -->> Server: allowedFields + aliases
    loop up to 3 attempts
      Server ->> Builder: build PlannerPayload (analysisPlan, allowedFields, feedback)
      Builder -->> Server: PlannerPayload JSON
      Server -->> Server: Zod validation + preflight checks
      alt validation or preflight error
        Server -->> Server: append feedback for next attempt
      else
        Server ->> MCP: query-datasource(payload)
        alt Tableau error
          MCP -->> Server: error message
          Server -->> Server: add tableau feedback
        else success
          MCP -->> Server: rows + data
          Server ->> Store: persist artifact path
          Server ->> Summary: summarize(analysisPlan, artifacts)
          Summary -->> Server: final reply
        end
      end
    end
        </pre>
      </div>
    </section>

    <div class="grid">
      <section class="card">
        <h2>Event Timeline</h2>
        <div class="zoom-controls">
          <button data-action="out" type="button">-</button>
          <span>Zoom</span>
          <button data-action="in" type="button">+</button>
          <button data-action="reset" type="button">Reset</button>
          <button data-action="fit" type="button">Fit</button>
          <span class="scale-display">100%</span>
        </div>
        <div class="zoomable timeline-full">
          <pre class="mermaid">
flowchart TD
    A[User Request] --> B[metadata:start]
    B --> C[metadata:done]
    C --> D[triage:start]
    D --> E[triage:done]
    E -->|clarify? yes| Z[final]
    E --> F[plan:done]
    F --> G[selector:start]
    G --> H{selector result}
    H -->|clarify| Z
    H --> I[selector:done]
    I --> J[fetch:start]
    J --> K{retry needed?}
    K -->|builder/preflight/Tableau| L[fetch:retry]
    L --> J
    K -->|error| M[fetch:error]
    K -->|success| N[fetch:done]
    N --> O[summarize:start]
    O --> P{CI needed?}
    P -->|yes| Q[summarize:ci:*]
    P -->|no| R[summarize:lightweight:*]
    Q --> S[final]
    R --> S
    S --> T[SSE close]
          </pre>
        </div>
      </section>

      <div>
        <section class="card">
          <h2>Implementation Notes</h2>
          <ul>
            <li><strong>Session management</strong>: In-memory `sessionStore` keyed by `conversationId`; artifacts and triage context persist across follow-up turns.</li>
            <li><strong>Stop handling</strong>: Companion `controllerStore` keeps per-conversation AbortControllers so POST /chat/orchestrator/stop can cancel streams and dispose heartbeats.</li>
            <li><strong>Triage</strong>: Produces <=2 plan steps plus `future_suggestions`; emits `plan:done` rather than calling a separate planner.</li>
            <li><strong>Field selector</strong>: Receives `MAX_N` (currently 3) from the orchestrator and honors triage-required fields and filter hints.</li>
            <li><strong>VizQL compilation</strong>: `fetchRunner` orchestrates builder retries, Zod validation, preflight checks, and Tableau MCP execution.</li>
            <li><strong>Summarization</strong>: `summary/run.ts` toggles between lightweight and CI based on plan/row thresholds and surfaces CI timeouts as fallbacks.</li>
            <li><strong>UI finish</strong>: Streaming panel auto-collapses after the final reply and relabels its summary to emphasize completion while leaving timings available.</li>
            <li><strong>Logging</strong>: `logs/analysis.txt` captures every orchestrator event, retry payload, and summarization outcome.</li>
            <li><strong>Configuration</strong>: Requires `TABLEAU_MCP_FILEPATH` and `OPENAI_API_KEY`; optional timeouts and log paths are read from the environment.</li>
          </ul>
        </section>

        <section class="card">
          <h2>Configuration & Runbook</h2>
          <div class="kvs">
            <div>Required:</div><div><code>TABLEAU_MCP_FILEPATH</code>, <code>OPENAI_API_KEY</code></div>
            <div>Optional:</div><div><code>PORT</code> (8787), <code>ANALYSIS_LOG_FILE</code>, <code>SUMMARIZE_CI_TIMEOUT_MS</code> (180000), <code>TABLEAU_CLIENT_TIMEOUT_MS</code>, <code>METADATA_CACHE_TTL_MS</code></div>
            <div>Setup:</div><div><code>npm install</code> -> <code>npm run dev</code> -> open <code>http://localhost:8787/</code></div>
            <div>UI Flow:</div><div>Provide datasourceLuid -> ask question -> conversationId auto-generated</div>
          </div>
          <div class="chips">
            <span class="chip">CORS enabled</span>
            <span class="chip">Graceful shutdown (SIGINT/SIGTERM)</span>
            <span class="chip">Static assets served from frontend/</span>
            <span class="chip">Session state not persisted across restarts</span>
          </div>
        </section>
      </div>
    </div>

    <p class="footer">Documentation aligned with `docs/specs/overview-asis.md` and `overview-tobe.md`.</p>
  </div>
</body>
</html>
